{"body": "<div class=\"section\" id=\"advanced-interactive-visualization\">\n<span id=\"example-viz-advanced\"></span><h1>Advanced interactive visualization<a class=\"headerlink\" href=\"#advanced-interactive-visualization\" title=\"Permalink to this headline\">\u00b6</a></h1>\n<p>In DIPY we created a thin interface to access many of the capabilities\navailable in the Visualization Toolkit framework (VTK) but tailored to the\nneeds of structural and diffusion imaging. Initially the 3D visualization\nmodule was named <code class=\"docutils literal\"><span class=\"pre\">fvtk</span></code>, meaning functions using vtk. This is still available\nfor backwards compatibility but now there is a more comprehensive way to access\nthe main functions using the following modules.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">import</span> <span class=\"nn\">numpy</span> <span class=\"k\">as</span> <span class=\"nn\">np</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.viz</span> <span class=\"k\">import</span> <span class=\"n\">actor</span><span class=\"p\">,</span> <span class=\"n\">window</span><span class=\"p\">,</span> <span class=\"n\">widget</span>\n</pre></div>\n</div>\n<p>In <code class=\"docutils literal\"><span class=\"pre\">window</span></code> we have all the objects that connect what needs to be rendered\nto the display or the disk e.g., for saving screenshots. So, there you will find\nkey objects and functions like the <code class=\"docutils literal\"><span class=\"pre\">Renderer</span></code> class which holds and provides\naccess to all the actors and the <code class=\"docutils literal\"><span class=\"pre\">show</span></code> function which displays what is\nin the renderer on a window. Also, this module provides access to functions\nfor opening/saving dialogs and printing screenshots (see <code class=\"docutils literal\"><span class=\"pre\">snapshot</span></code>).</p>\n<p>In the <code class=\"docutils literal\"><span class=\"pre\">actor</span></code> module we can find all the different primitives e.g.,\nstreamtubes, lines, image slices, etc.</p>\n<p>In the <code class=\"docutils literal\"><span class=\"pre\">widget</span></code> we have some other objects which allow to add buttons\nand sliders and these interact both with windows and actors. Because of this\nthey need input from the operating system so they can process events.</p>\n<p>Let&#8217;s get started. In this tutorial, we will visualize some bundles\ntogether with FA or T1. We will be able to change the slices using\na <code class=\"docutils literal\"><span class=\"pre\">slider</span></code> widget.</p>\n<p>First we need to fetch and load some datasets.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">from</span> <span class=\"nn\">dipy.data.fetcher</span> <span class=\"k\">import</span> <span class=\"n\">fetch_bundles_2_subjects</span><span class=\"p\">,</span> <span class=\"n\">read_bundles_2_subjects</span>\n\n<span class=\"n\">fetch_bundles_2_subjects</span><span class=\"p\">()</span>\n</pre></div>\n</div>\n<p>The following function outputs a dictionary with the required bundles e.g., af\nleft (left arcuate fasciculus) and maps, e.g., FA for a specific subject.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">res</span> <span class=\"o\">=</span> <span class=\"n\">read_bundles_2_subjects</span><span class=\"p\">(</span><span class=\"s1\">&#39;subj_1&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;t1&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;fa&#39;</span><span class=\"p\">],</span>\n                              <span class=\"p\">[</span><span class=\"s1\">&#39;af.left&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;cst.right&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;cc_1&#39;</span><span class=\"p\">])</span>\n</pre></div>\n</div>\n<p>We will use 3 bundles, FA and the affine transformation that brings the voxel\ncoordinates to world coordinates (RAS 1mm).</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">streamlines</span> <span class=\"o\">=</span> <span class=\"n\">res</span><span class=\"p\">[</span><span class=\"s1\">&#39;af.left&#39;</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"n\">res</span><span class=\"p\">[</span><span class=\"s1\">&#39;cst.right&#39;</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"n\">res</span><span class=\"p\">[</span><span class=\"s1\">&#39;cc_1&#39;</span><span class=\"p\">]</span>\n<span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">res</span><span class=\"p\">[</span><span class=\"s1\">&#39;fa&#39;</span><span class=\"p\">]</span>\n<span class=\"n\">shape</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">shape</span>\n<span class=\"n\">affine</span> <span class=\"o\">=</span> <span class=\"n\">res</span><span class=\"p\">[</span><span class=\"s1\">&#39;affine&#39;</span><span class=\"p\">]</span>\n</pre></div>\n</div>\n<p>With our current design it is easy to decide in which space you want the\nstreamlines and slices to appear. The default we have here is to appear in\nworld coordinates (RAS 1mm).</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">world_coords</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</pre></div>\n</div>\n<p>If we want to see the objects in native space we need to make sure that all\nobjects which are currently in world coordinates are transformed back to\nnative space using the inverse of the affine.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">world_coords</span><span class=\"p\">:</span>\n    <span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.streamline</span> <span class=\"k\">import</span> <span class=\"n\">transform_streamlines</span>\n    <span class=\"n\">streamlines</span> <span class=\"o\">=</span> <span class=\"n\">transform_streamlines</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">linalg</span><span class=\"o\">.</span><span class=\"n\">inv</span><span class=\"p\">(</span><span class=\"n\">affine</span><span class=\"p\">))</span>\n</pre></div>\n</div>\n<p>Now we create, a <code class=\"docutils literal\"><span class=\"pre\">Renderer</span></code> object and add the streamlines using the <code class=\"docutils literal\"><span class=\"pre\">line</span></code>\nfunction and an image plane using the <code class=\"docutils literal\"><span class=\"pre\">slice</span></code> function.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">ren</span> <span class=\"o\">=</span> <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">Renderer</span><span class=\"p\">()</span>\n<span class=\"n\">stream_actor</span> <span class=\"o\">=</span> <span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">line</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">)</span>\n\n<span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">world_coords</span><span class=\"p\">:</span>\n    <span class=\"n\">image_actor</span> <span class=\"o\">=</span> <span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">slicer</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"o\">=</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">eye</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">))</span>\n<span class=\"k\">else</span><span class=\"p\">:</span>\n    <span class=\"n\">image_actor</span> <span class=\"o\">=</span> <span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">slicer</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>We can also change also the opacity of the slicer</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">slicer_opacity</span> <span class=\"o\">=</span> <span class=\"o\">.</span><span class=\"mi\">6</span>\n<span class=\"n\">image_actor</span><span class=\"o\">.</span><span class=\"n\">opacity</span><span class=\"p\">(</span><span class=\"n\">slicer_opacity</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Connect the actors with the Renderer.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">ren</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">stream_actor</span><span class=\"p\">)</span>\n<span class=\"n\">ren</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">image_actor</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Now we would like to change the position of the <code class=\"docutils literal\"><span class=\"pre\">image_actor</span></code> using a slider.\nThe sliders are widgets which require access to different areas of the\nvisualization pipeline and therefore we don&#8217;t recommend using them with\n<code class=\"docutils literal\"><span class=\"pre\">show</span></code>. The more appropriate way is to use them with the <code class=\"docutils literal\"><span class=\"pre\">ShowManager</span></code>\nobject which allows accessing the pipeline in different areas. Here is how:</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">show_m</span> <span class=\"o\">=</span> <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">ShowManager</span><span class=\"p\">(</span><span class=\"n\">ren</span><span class=\"p\">,</span> <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">1200</span><span class=\"p\">,</span> <span class=\"mi\">900</span><span class=\"p\">))</span>\n<span class=\"n\">show_m</span><span class=\"o\">.</span><span class=\"n\">initialize</span><span class=\"p\">()</span>\n</pre></div>\n</div>\n<p>After we have initialized the <code class=\"docutils literal\"><span class=\"pre\">ShowManager</span></code> we can go ahead and create a\ncallback which will be given to the <code class=\"docutils literal\"><span class=\"pre\">slider</span></code> function.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"k\">def</span> <span class=\"nf\">change_slice</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">event</span><span class=\"p\">):</span>\n    <span class=\"n\">z</span> <span class=\"o\">=</span> <span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">round</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">get_value</span><span class=\"p\">()))</span>\n    <span class=\"n\">image_actor</span><span class=\"o\">.</span><span class=\"n\">display_extent</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">shape</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"o\">-</span> <span class=\"mi\">1</span><span class=\"p\">,</span>\n                               <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">shape</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span> <span class=\"o\">-</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"n\">z</span><span class=\"p\">,</span> <span class=\"n\">z</span><span class=\"p\">)</span>\n\n<span class=\"n\">slider</span> <span class=\"o\">=</span> <span class=\"n\">widget</span><span class=\"o\">.</span><span class=\"n\">slider</span><span class=\"p\">(</span><span class=\"n\">show_m</span><span class=\"o\">.</span><span class=\"n\">iren</span><span class=\"p\">,</span> <span class=\"n\">show_m</span><span class=\"o\">.</span><span class=\"n\">ren</span><span class=\"p\">,</span>\n                       <span class=\"n\">callback</span><span class=\"o\">=</span><span class=\"n\">change_slice</span><span class=\"p\">,</span>\n                       <span class=\"n\">min_value</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span>\n                       <span class=\"n\">max_value</span><span class=\"o\">=</span><span class=\"n\">shape</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span> <span class=\"o\">-</span> <span class=\"mi\">1</span><span class=\"p\">,</span>\n                       <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">shape</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span> <span class=\"o\">/</span> <span class=\"mi\">2</span><span class=\"p\">,</span>\n                       <span class=\"n\">label</span><span class=\"o\">=</span><span class=\"s2\">&quot;Move slice&quot;</span><span class=\"p\">,</span>\n                       <span class=\"n\">right_normalized_pos</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"o\">.</span><span class=\"mi\">98</span><span class=\"p\">,</span> <span class=\"mf\">0.6</span><span class=\"p\">),</span>\n                       <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">120</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">),</span> <span class=\"n\">label_format</span><span class=\"o\">=</span><span class=\"s2\">&quot;%0.lf&quot;</span><span class=\"p\">,</span>\n                       <span class=\"n\">color</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mf\">1.</span><span class=\"p\">,</span> <span class=\"mf\">1.</span><span class=\"p\">,</span> <span class=\"mf\">1.</span><span class=\"p\">),</span>\n                       <span class=\"n\">selected_color</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mf\">0.86</span><span class=\"p\">,</span> <span class=\"mf\">0.33</span><span class=\"p\">,</span> <span class=\"mf\">1.</span><span class=\"p\">))</span>\n</pre></div>\n</div>\n<p>Then, we can render all the widgets and everything else in the screen and\nstart the interaction using <code class=\"docutils literal\"><span class=\"pre\">show_m.start()</span></code>.</p>\n<p>However, if you change the window size, the slider will not update its position\nproperly. The solution to this issue is to update the position of the slider\nusing its <code class=\"docutils literal\"><span class=\"pre\">place</span></code> method every time the window size changes.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"k\">global</span> <span class=\"n\">size</span>\n<span class=\"n\">size</span> <span class=\"o\">=</span> <span class=\"n\">ren</span><span class=\"o\">.</span><span class=\"n\">GetSize</span><span class=\"p\">()</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">win_callback</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">event</span><span class=\"p\">):</span>\n    <span class=\"k\">global</span> <span class=\"n\">size</span>\n    <span class=\"k\">if</span> <span class=\"n\">size</span> <span class=\"o\">!=</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">GetSize</span><span class=\"p\">():</span>\n\n        <span class=\"n\">slider</span><span class=\"o\">.</span><span class=\"n\">place</span><span class=\"p\">(</span><span class=\"n\">ren</span><span class=\"p\">)</span>\n        <span class=\"n\">size</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">GetSize</span><span class=\"p\">()</span>\n\n<span class=\"n\">show_m</span><span class=\"o\">.</span><span class=\"n\">initialize</span><span class=\"p\">()</span>\n</pre></div>\n</div>\n<p>Finally, please uncomment the following 3 lines so that you can interact with\nthe available 3D and 2D objects.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># show_m.add_window_callback(win_callback)</span>\n<span class=\"c1\"># show_m.render()</span>\n<span class=\"c1\"># show_m.start()</span>\n\n<span class=\"n\">ren</span><span class=\"o\">.</span><span class=\"n\">zoom</span><span class=\"p\">(</span><span class=\"mf\">1.5</span><span class=\"p\">)</span>\n<span class=\"n\">ren</span><span class=\"o\">.</span><span class=\"n\">reset_clipping_range</span><span class=\"p\">()</span>\n\n<span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">ren</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;bundles_and_a_slice.png&#39;</span><span class=\"p\">,</span> <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">1200</span><span class=\"p\">,</span> <span class=\"mi\">900</span><span class=\"p\">),</span>\n              <span class=\"n\">reset_camera</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"figure align-center\" id=\"id1\">\n<img alt=\"../../_images/bundles_and_a_slice.png\" src=\"../../_images/bundles_and_a_slice.png\" />\n<p class=\"caption\"><span class=\"caption-text\"><strong>A few bundles with interactive slicing</strong>.</span></p>\n</div>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"k\">del</span> <span class=\"n\">show_m</span>\n</pre></div>\n</div>\n<div class=\"admonition-example-source-code admonition\">\n<p class=\"first admonition-title\">Example source code</p>\n<p class=\"last\">You can download <a class=\"reference download internal\" href=\"../../_downloads/viz_advanced.py\" download=\"\"><code class=\"xref download docutils literal\"><span class=\"pre\">the</span> <span class=\"pre\">full</span> <span class=\"pre\">source</span> <span class=\"pre\">code</span> <span class=\"pre\">of</span> <span class=\"pre\">this</span> <span class=\"pre\">example</span></code></a>.\nThis same script is also included in the dipy source distribution under the\n<code class=\"file docutils literal\"><span class=\"pre\">doc/examples/</span></code> directory.</p>\n</div>\n</div>\n", "alabaster_version": "0.7.7", "display_toc": false, "title": "Advanced interactive visualization", "sourcename": "examples_built/viz_advanced.txt", "customsidebar": null, "metatags": "", "current_page_name": "examples_built/viz_advanced", "next": null, "rellinks": [["genindex", "General Index", "I", "index"]], "meta": {}, "parents": [], "sidebars": null, "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Advanced interactive visualization</a></li>\n</ul>\n", "prev": null, "page_source_suffix": ".rst"}